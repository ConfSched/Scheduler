#include <iostream>
#include <mysql.h>
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <iostream>
#include "paper.h"
#include "room.h"
#include "author.h"
#include "session.h"

//The below section stores the connection information for the SQL server
#define serverAddress "localhost"  // IP or FQDN of the server
#define username "cjdresearch"     // Login username
#define password "s3nrs@ch!"       // Login password
#define dbName "confsched"         // Database name used for the conference information

using namespace std;

// SQL Helper Functions

//Pre:  *con contains an error message
//Post:  The error message has been sent to the console
void dispSqlError(MYSQL *con)
{
  cerr << "About to display an error" << endl;
  fprintf(stderr, "%s\n", mysql_error(con));
  mysql_close(con);
  cerr << "Closing the connection" << endl;
  exit(1);
}

//Pre:
//Post:  returns the number of rows in the specified table
int getRows (MYSQL *myCon, const char* tableName) {
  int RV=0;
  const char* query = "SELECT * FROM ";
  char* queryName = new char[strlen(tableName)+strlen(query)+1];
  strcpy (queryName, query);
  strcat (queryName, tableName);
//  cerr << "getRows: query  = " << queryName << endl;
//  if (myCon==NULL) cerr << "getRows myCon=NULL" << endl;
//    else cerr << "getRows myCON != NULL" << endl;
  if (mysql_query(myCon, queryName)) {
//    cerr << "getRows:  mysql_query error.  Calling dispSqlError" << endl;
    dispSqlError(myCon);
  }
  else {
 //   cerr << "getRows:  mysql_query succeeded, checking result" << endl;
    MYSQL_RES *result = mysql_store_result(myCon);
    if (result == NULL) {
 //     cerr << "getRows:  mysql_store_result=NULL, calling dispSqlError" << endl;
      dispSqlError(myCon);
    }
    else RV = mysql_num_rows(result);
  }
//  cerr << "getRows:  Number of rows=" << RV << endl;
  return (RV);
}

//Pre:  myCon is a MYSQL objec
//Post:  myCon is a valid connection to the database or an appropriate
//      error has been displayed
void connectDB (MYSQL *myCon, bool errorStatus) {
//  myCon = mysql_init(NULL);
  if (myCon == NULL) { //Init failed, print error
//    cerr << "connectDB: mysql_init() failed" << endl;
    errorStatus=true;
  }
//  else cerr << "connectDB: mysql_init() succeeded" << endl;
  const char* serverLocation = serverAddress;
  const char* serverUser = username;
  const char* serverPass = password;
  const char* databaseName = dbName;
//  cerr << "connectDB: database=" << databaseName << " at " << serverLocation;
//  cerr << " Username=" << serverUser << " and password=" << serverPass << endl;
  if (mysql_real_connect(myCon, serverLocation, serverUser, serverPass, databaseName,
            0, NULL, 0) == NULL){ //An error ocurred on connection, print error
    dispSqlError(myCon);
    errorStatus=true;
  }
//  cerr << "connectDB: Final error state: " << errorStatus << endl;
//  if (myCon == NULL) cerr << "connectDB: myCon==NULL" << endl;
//    else cerr << "connectDB: myCon != NULL" << endl;
}
